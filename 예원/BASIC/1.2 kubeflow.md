# ğŸ– kubeflow?
: ë¦¬ì†ŒìŠ¤ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ í”Œë«í¼ì¸ ì¿ ë²„ë„¤í‹°ìŠ¤ ìœ„ì—ì„œ ì‹¤í–‰ë˜ëŠ” ML toolkit

**ëª©í‘œ** : ML ì›Œí¬í”Œë¡œìš°ì— í•„ìš”í•œ ì„œë¹„ìŠ¤ë¥¼ ë§Œë“œëŠ”ê²Œ ì•„ë‹ˆë¼ **ê° ì˜ì—­ì—ì„œ ê°€ì¥ ì í•©í•œ ì˜¤í”ˆì†ŒìŠ¤ ì‹œìŠ¤í…œë“¤ì„ ì œê³µí•˜ëŠ” ê²ƒ**

ì»´í¬ë„ŒíŠ¸ë“¤ : ì£¼í”¼í„° ë…¸íŠ¸ë¶, ë©”ì¸ ëŒ€ì‰¬ë³´ë“œ, í•˜ì´í¼íŒŒë¼ë¯¸í„° íŠœë‹, íŒŒì´í”„ë¼ì¸, ì„œë¹™, í•™ìŠµ, ê·¸ ì™¸.. 

# ğŸ”¥ How to Install

kubeflow ì„¤ì¹˜ ìµœì†Œ ì‚¬ì–‘:
- 4 CPU ì´ìƒ
- 50 GB ìŠ¤í† ë¦¬ì§€ ì´ìƒ
- 12 GB ë©”ëª¨ë¦¬ ì´ìƒ

ë°©ë²•ì€ ë‹¤ì–‘í•¨ 

1. minikube / minikf (kubeflow ë§Œ ì‚¬ìš©í• ê±°ë¼ë©´ ë‹¨ì¼ ë…¸ë“œ í™˜ê²½ë„ ê´œì°®ìŒ)
    
    ì°¸ê³ : https://magoker.tistory.com/93, https://rfriend.tistory.com/676
2. í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ (AWS EKS, NCP NKS, GCP GKE..)
3. VM ë§ˆìŠ¤í„° & ì›Œì»¤ ë„ìš°ê¸°

ì‚¬ì‹¤ ëª¨ë‘ ì‹œë„í•´ë´¤ëŠ”ë° ì±… ì‹¤ìŠµ ì¤‘ì— ë§‰íˆëŠ”ê²Œ ì—†ìœ¼ë©´ ê·¸ëƒ¥ minikf ì‚¬ìš©í•  ê²ƒ ê°™ë‹¤. ~~ë¬¸ì œê°€ ìˆë‹¤ë©´ 3ë²ˆìœ¼ë¡œ ê·¸ëŒ€ë¡œ ê°€ëŠ”ê±¸ë¡œ...~~

## ë„ì»¤ ì„¸íŒ…
```
$ sudo apt-get update
$ sudo apt-get install -y apt-transport-https ca-certificates curl gnupg-agent software-properties-common
$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
$ sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
$ sudo apt-get update
$ sudo apt-get install -y docker-ce=5:18.09.9~3-0~ubuntu-bionic docker-ce-cli=5:18.09.9~3-0~ubuntu-bionic containerd.io vim

$ sudo su
$ cat > /etc/docker/daemon.json <<EOF
{
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m"
  },
  "storage-driver": "overlay2"
}
EOF
$ mkdir -p /etc/systemd/system/docker.service.d
$ systemctl daemon-reload
$ systemctl restart docker
$ exit
```

## ì¿ ë²„ë„¤í‹°ìŠ¤ ì„¸íŒ…
- ê³µí†µ
```
$ curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add 
$ sudo apt-add-repository "deb http://apt.kubernetes.io/ kubernetes-xenial main"
$ sudo apt install -y kubelet=1.15.5-00 kubeadm=1.15.5-00 kubectl=1.15.5-00
$ sudo apt-mark hold kubelet kubeadm kubectl
$ sudo sysctl net.bridge.bridge-nf-call-iptables=1
```

- ë§ˆìŠ¤í„°
```
$ sudo swapoff -a
$ sudo kubeadm init --pod-network-cidr=192.168.0.0/16
$ mkdir -p $HOME/.kube
$ sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
$ sudo chown $(id -u):$(id -g) $HOME/.kube/config
$ kubectl taint nodes --all node-role.kubernetes.io/master-
$ kubectl apply -f https://docs.projectcalico.org/v3.11/manifests/calico.yaml
```

- ì›Œì»¤
```
$ sudo su
$ swapoff -a
$ sudo vi /etc/fstab  # swap ìª½ ì£¼ì„ì²˜ë¦¬
$ sudo kubeadm join ë§ˆìŠ¤í„°ë…¸ë“œì•„ì´í”¼:6443 --token í† í° --discovery-token-ca-cert-hash sha256:í•´ì‰¬ê°’
```

## nfs ì„¤ì • (ìŠ¤í† ë¦¬ì§€ ì„œë²„ë¥¼ í•œê°œ ì„ íƒí•´ì„œ ì§„í–‰)
```
$ sudo mkdir -p /mnt/storage/nfs_storage
$ sudo chmod -R 777 /mnt/storage/nfs_storage
$ sudo apt-get -y install nfs-common nfs-kernel-server
$ kubectl get node -o wide
$ sudo vi /etc/exports

###
/mnt/storage/nfs_storage ë§ˆìŠ¤í„° ip(rw,insecure,sync,no_root_squash,no_subtree_check)
/mnt/storage/nfs_storage ì›Œì»¤ ip(rw,insecure,sync,no_root_squash,no_subtree_check)

$ sudo exportfs -a
$ sudo systemctl restart nfs-kernel-server
$ sudo apt install nfs-common
$ mkdir test_mount
$ sudo mount nfsì„œë²„ip:/mnt/storage/nfs_storage test_mount
$ touch test_mount/file.txt
$ ls /mnt/storage/nfs_storage

$ kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/master/deploy/local-path-storage.yaml
$ curl https://raw.githubusercontent.com/helm/helm/release-2.16/scripts/get > get_helm.sh
$ chmod 700 get_helm.sh
$ ./get_helm.sh
$ helm repo add stable https://kubernetes-charts.storage.googleapis.com/
$ helm install --generate-name  --set nfs.server=ipì£¼ì†Œ --set nfs.path=/mnt/storage/nfs_storage stable/nfs-client-provisioner

$ kubectl patch storageclass nfs-client -p '{"metadata":{"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'
$ kubectl get storageclass
```

## ë„ì»¤ private registry ë°°í¬

```
$ kubectl apply -f https://raw.githubusercontent.com/mojokb/handson-kubeflow/master/registry/kubeflow-registry-deploy.yaml
$ kubectl apply -f https://raw.githubusercontent.com/mojokb/handson-kubeflow/master/registry/kubeflow-registry-svc.yaml

$ sudo vi /etc/docker/daemon.json

### ì¶”ê°€
"insecure-registries": [
        "kubeflow-registry.default.svc.cluster.local:30000"
]

$ sudo systemctl daemon-reload
$ sudo systemctl restart docker

$ sudo vi /etc/hosts
# ë§ˆìŠ¤í„°ë…¸ë“œ ip   kubeflow-registry.default.svc.cluster.local

# ì›Œì»¤ì—ì„œ í™•ì¸
$ curl kubeflow-registry.default.svc.cluster.local:30000/v2/_catalog
```

## k9s ì„¤ì¹˜
```
$ wget https://github.com/derailed/k9s/releases/download/v0.13.7/k9s_0.13.7_linux_i386.tar.gz
$ tar zxvf k9s_0.13.7_linux_i386.tar.gz
$ sudo mv k9s /usr/bin
$ k9s

# ì¢…ë£ŒëŠ” :q
```

## kfctl ì„¤ì¹˜
```
$ wget https://github.com/kubeflow/kfctl/releases/download/v1.0.2/kfctl_v1.0.2-0-ga476281_linux.tar.gz
$ tar zxvf kfctl_v1.0.2-0-ga476281_linux.tar.gz
$ sudo mv kfctl /usr/bin
```

## kubeflow ì„¤ì¹˜
```
$ export KF_NAME=yw-kubeflow
$ export BASE_DIR=/home/${USER}
$ export KF_DIR=${BASE_DIR}/${KF_NAME}
$ export CONFIG_URI="https://raw.githubusercontent.com/kubeflow/manifests/v1.0-branch/kfdef/kfctl_k8s_istio.v1.0.2.yaml"
$ sudo mkdir -p ${KF_DIR}
$ sudo chmod 777 ${KF_DIR}
$ cd ${KF_DIR}
$ kfctl apply -V -f ${CONFIG_URI}

# ì„¤ì¹˜ í™•ì¸
$ kubectl get pods -n kubeflow -o wide 
```